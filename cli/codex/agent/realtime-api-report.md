# Codex Realtime API å®ç°æ·±åº¦åˆ†ææŠ¥å‘Š

åŸºäºå¯¹é¡¹ç›®æºä»£ç çš„è¯¦ç»†åˆ†æï¼Œä»¥ä¸‹æ˜¯ Codex Realtime API çš„å®Œæ•´æ¶æ„è®¾è®¡å’Œå®ç°ç»†èŠ‚ã€‚

---

## 0. Realtime API ç”¨é€”ä¸åº”ç”¨åœºæ™¯

### 0.1 ä»€ä¹ˆæ˜¯ Realtime APIï¼Ÿ

Realtime API æ˜¯ Codex æä¾›çš„**ä½å»¶è¿ŸåŒå‘å®æ—¶é€šä¿¡æ¥å£**ï¼Œæ”¯æŒé€šè¿‡ WebSocket è¿›è¡Œ**è¯­éŸ³å’Œæ–‡æœ¬çš„å®æ—¶äº¤äº’**ã€‚ä¸ä¼ ç»Ÿçš„è¯·æ±‚-å“åº”æ¨¡å¼ä¸åŒï¼ŒRealtime API é‡‡ç”¨æµå¼å¤„ç†ï¼Œå…è®¸ï¼š

- **å®æ—¶è¯­éŸ³è¾“å…¥**ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡éº¦å…‹é£å®æ—¶å‘é€è¯­éŸ³æ•°æ®
- **å®æ—¶è¯­éŸ³è¾“å‡º**ï¼šAI åŠ©æ‰‹å¯ä»¥æµå¼è¿”å›è¯­éŸ³å“åº”
- **å®æ—¶æ–‡æœ¬äº¤äº’**ï¼šæ”¯æŒæ–‡æœ¬å’Œè¯­éŸ³æ··åˆè¾“å…¥è¾“å‡º
- **ä½å»¶è¿Ÿå¯¹è¯**ï¼šé€‚ç”¨äºéœ€è¦å³æ—¶å“åº”çš„äº¤äº’åœºæ™¯

### 0.2 æ ¸å¿ƒåº”ç”¨åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Realtime API åº”ç”¨åœºæ™¯                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ™ï¸ è¯­éŸ³åŠ©æ‰‹                                                    â”‚
â”‚     â”œâ”€â”€ å®æ—¶è¯­éŸ³å¯¹è¯ï¼ˆç±»ä¼¼ Siri/Google Assistantï¼‰              â”‚
â”‚     â”œâ”€â”€ è¯­éŸ³æ§åˆ¶ä»£ç ç¼–è¾‘å™¨                                      â”‚
â”‚     â””â”€â”€ å…æç¼–ç¨‹è¾…åŠ©                                            â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ å®æ—¶åä½œ                                                    â”‚
â”‚     â”œâ”€â”€ è¿œç¨‹ç»“å¯¹ç¼–ç¨‹                                            â”‚
â”‚     â”œâ”€â”€ å®æ—¶ä»£ç å®¡æŸ¥è®¨è®º                                        â”‚
â”‚     â””â”€â”€ å³æ—¶æŠ€æœ¯æ”¯æŒ                                            â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”„ æµå¼å¤„ç†                                                    â”‚
â”‚     â”œâ”€â”€ é•¿æ–‡æœ¬å®æ—¶æœ—è¯»ï¼ˆTTSï¼‰                                    â”‚
â”‚     â”œâ”€â”€ å®æ—¶è¯­éŸ³è½¬æ–‡å­—ï¼ˆSTTï¼‰                                    â”‚
â”‚     â””â”€â”€ å¤šæ¨¡æ€äº¤äº’ï¼ˆè¯­éŸ³+æ–‡æœ¬æ··åˆï¼‰                              â”‚
â”‚                                                                 â”‚
â”‚  âš¡ ä½å»¶è¿Ÿåœºæ™¯                                                  â”‚
â”‚     â”œâ”€â”€ éœ€è¦å³æ—¶åé¦ˆçš„äº¤äº’                                      â”‚
â”‚     â”œâ”€â”€ å®æ—¶è°ƒè¯•ä¼šè¯                                            â”‚
â”‚     â””â”€â”€ å¿«é€ŸåŸå‹è¿­ä»£                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 0.3 ä¸ä¼ ç»Ÿ API çš„å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿ Chat API | Realtime API |
|------|--------------|--------------|
| **é€šä¿¡åè®®** | HTTP REST | WebSocket |
| **æ•°æ®ä¼ è¾“** | è¯·æ±‚-å“åº” | åŒå‘æµ |
| **å»¶è¿Ÿ** | è¾ƒé«˜ï¼ˆéœ€ç­‰å¾…å®Œæ•´å“åº”ï¼‰ | æä½ï¼ˆæµå¼å¤„ç†ï¼‰ |
| **è¯­éŸ³æ”¯æŒ** | éœ€é¢å¤–è°ƒç”¨ TTS/STT | åŸç”Ÿæ”¯æŒ |
| **é€‚ç”¨åœºæ™¯** | æ‰¹é‡å¤„ç†ã€éå®æ—¶ | å®æ—¶äº¤äº’ã€è¯­éŸ³å¯¹è¯ |
| **èµ„æºæ¶ˆè€—** | æŒ‰è¯·æ±‚è®¡è´¹ | æŒ‰è¿æ¥æ—¶é•¿è®¡è´¹ |

### 0.4 åœ¨ Codex ä¸­çš„å®šä½

```
Codex æ¶æ„ä¸­çš„ Realtime API ä½ç½®ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·ç•Œé¢å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   CLI    â”‚  â”‚   TUI    â”‚  â”‚  App (Web/Desktop)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚                   â”‚
        â–¼             â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€šä¿¡åè®®å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ JSON-RPC 2.0     â”‚      â”‚ WebSocket (Realtime)     â”‚   â”‚
â”‚  â”‚ (ä¼ ç»Ÿè¯·æ±‚-å“åº”)   â”‚      â”‚ (å®æ—¶åŒå‘æµ)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                             â”‚
            â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒä¸šåŠ¡å±‚ (codex-core)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CodexThread      â”‚      â”‚ RealtimeConversation     â”‚   â”‚
â”‚  â”‚ TurnManager      â”‚      â”‚ Manager                  â”‚   â”‚
â”‚  â”‚ (å›åˆåˆ¶å¯¹è¯)      â”‚      â”‚ (æµå¼å¯¹è¯)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. API æ¶æ„è®¾è®¡æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒæ¶æ„æ¨¡å¼

Realtime API å®ç°é‡‡ç”¨ **Actor æ¨¡å¼** + **å¼‚æ­¥é€šé“** çš„è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Codex Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Op::RealtimeConversationStart
         â”‚ Op::RealtimeConversationAudio
         â”‚ Op::RealtimeConversationText
         â”‚ Op::RealtimeConversationClose
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Codex Session (codex.rs)   â”‚
â”‚  - Submission Handler       â”‚
â”‚  - Event Broadcaster        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RealtimeConversationManager          â”‚
â”‚  (realtime_conversation.rs)           â”‚
â”‚  - State Management (Mutex)           â”‚
â”‚  - Channel Orchestration              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                      â”‚
    â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket Client   â”‚     â”‚ Realtime Input Task      â”‚
â”‚ (tokio_tungstenite) â”‚     â”‚ (tokio::spawn)           â”‚
â”‚                     â”‚     â”‚                          â”‚
â”‚ - Connection        â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ - Writer/Events     â”‚     â”‚ â”‚ tokio::select! {      â”‚ â”‚
â”‚ - Message Pump      â”‚     â”‚ â”‚  text_rx.recv()      â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚  events.next_event() â”‚ â”‚
                            â”‚ â”‚  audio_rx.recv()     â”‚ â”‚
                            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å…³é”®ç±»å‹å®šä¹‰

**file**: `codex-rs/protocol/src/protocol.rs`

#### Operation ç±»å‹ï¼ˆæäº¤æ“ä½œï¼‰

```rust
pub enum Op {
    /// å¯åŠ¨å®æ—¶å¯¹è¯æµ
    RealtimeConversationStart(ConversationStartParams),

    /// å‘é€éŸ³é¢‘è¾“å…¥
    RealtimeConversationAudio(ConversationAudioParams),

    /// å‘é€æ–‡æœ¬è¾“å…¥
    RealtimeConversationText(ConversationTextParams),

    /// å…³é—­å¯¹è¯æµ
    RealtimeConversationClose,
}
```

#### å‚æ•°ç±»å‹

```rust
#[derive(Debug, Clone, PartialEq, JsonSchema, TS)]
pub struct ConversationStartParams {
    pub prompt: String,
    pub session_id: Option<String>,
}

#[derive(Debug, Clone, PartialEq, Eq, JsonSchema, TS)]
pub struct RealtimeAudioFrame {
    pub data: String,           // Base64ç¼–ç çš„PCMéŸ³é¢‘
    pub sample_rate: u32,       // é‡‡æ ·ç‡ï¼ˆå¦‚24000, 48000ï¼‰
    pub num_channels: u16,      // é€šé“æ•°ï¼ˆ1=å•å£°é“ï¼‰
    pub samples_per_channel: Option<u32>,  // æ¯é€šé“æ ·æœ¬æ•°
}

#[derive(Debug, Clone, PartialEq, Eq, JsonSchema, TS)]
pub enum RealtimeEvent {
    SessionCreated { session_id: String },
    SessionUpdated { backend_prompt: Option<String> },
    AudioOut(RealtimeAudioFrame),
    ConversationItemAdded(Value),  // JSONæ ¼å¼çš„å¯¹è¯é¡¹
    Error(String),
}
```

#### äº‹ä»¶ç±»å‹ï¼ˆå“åº”äº‹ä»¶ï¼‰

```rust
pub enum EventMsg {
    /// å¯¹è¯å¯åŠ¨äº‹ä»¶
    RealtimeConversationStarted(RealtimeConversationStartedEvent),

    /// å®æ—¶æµæ•°æ®äº‹ä»¶
    RealtimeConversationRealtime(RealtimeConversationRealtimeEvent),

    /// å¯¹è¯å…³é—­äº‹ä»¶
    RealtimeConversationClosed(RealtimeConversationClosedEvent),
    // ... å…¶ä»–äº‹ä»¶
}

#[derive(Debug, Clone)]
pub struct RealtimeConversationStartedEvent {
    pub session_id: Option<String>,
}

#[derive(Debug, Clone)]
pub struct RealtimeConversationRealtimeEvent {
    pub payload: RealtimeEvent,
}

#[derive(Debug, Clone)]
pub struct RealtimeConversationClosedEvent {
    pub reason: Option<String>,  // "requested", "transport_closed"
}
```

---

## 2. æ ¸å¿ƒç»„ä»¶å®ç°

### 2.1 RealtimeConversationManager

**file**: `codex-rs/core/src/realtime_conversation.rs`

#### ç»“æ„ä½“å®šä¹‰

```rust
pub(crate) struct RealtimeConversationManager {
    state: Mutex<Option<ConversationState>>,
}

struct ConversationState {
    audio_tx: Sender<RealtimeAudioFrame>,
    text_tx: Sender<String>,
    task: JoinHandle<()>,  // è¿è¡Œçš„åå°ä»»åŠ¡
}
```

#### é˜Ÿåˆ—å®¹é‡é…ç½®

```rust
const AUDIO_IN_QUEUE_CAPACITY: usize = 256;      // éŸ³é¢‘è¾“å…¥é˜Ÿåˆ—
const TEXT_IN_QUEUE_CAPACITY: usize = 64;        // æ–‡æœ¬è¾“å…¥é˜Ÿåˆ—
const OUTPUT_EVENTS_QUEUE_CAPACITY: usize = 256; // è¾“å‡ºäº‹ä»¶é˜Ÿåˆ—
```

#### å…³é”®æ–¹æ³•

**å¯åŠ¨å¯¹è¯æµ**

```rust
pub(crate) async fn start(
    &self,
    api_provider: ApiProvider,
    extra_headers: Option<HeaderMap>,
    prompt: String,
    session_id: Option<String>,
) -> CodexResult<Receiver<RealtimeEvent>>
```

- åˆ›å»º WebSocket è¿æ¥åˆ°åç«¯ Realtime API
- åˆå§‹åŒ–ä¸‰ä¸ªå¼‚æ­¥é€šé“ï¼ˆéŸ³é¢‘ã€æ–‡æœ¬ã€äº‹ä»¶ï¼‰
- å¯åŠ¨åå°è¾“å…¥å¤„ç†ä»»åŠ¡
- è¿”å›äº‹ä»¶æ¥æ”¶å™¨ç»™è°ƒç”¨è€…

**å‘é€éŸ³é¢‘**

```rust
pub(crate) async fn audio_in(&self, frame: RealtimeAudioFrame) -> CodexResult<()>
```

- ä½¿ç”¨ `try_send` ä¸é˜»å¡å‘é€
- é˜Ÿåˆ—æ»¡æ—¶è®°å½•è­¦å‘Šå¹¶ä¸¢å¼ƒå¸§ï¼ˆèƒŒå‹å¤„ç†ï¼‰

**å‘é€æ–‡æœ¬**

```rust
pub(crate) async fn text_in(&self, text: String) -> CodexResult<()>
```

- ä½¿ç”¨ `send` å¼‚æ­¥é˜»å¡å‘é€
- ç¡®ä¿æ–‡æœ¬æ¶ˆæ¯å¿…å®šè¢«æ¥æ”¶

**å…³é—­å¯¹è¯**

```rust
pub(crate) async fn shutdown(&self) -> CodexResult<()>
```

- ä¸­æ­¢åå°ä»»åŠ¡
- é‡Šæ”¾çŠ¶æ€

### 2.2 åå°è¾“å…¥å¤„ç†ä»»åŠ¡

**å®ç°**ï¼š`spawn_realtime_input_task` å‡½æ•°

```rust
fn spawn_realtime_input_task(
    writer: RealtimeWebsocketWriter,
    events: RealtimeWebsocketEvents,
    text_rx: Receiver<String>,
    audio_rx: Receiver<RealtimeAudioFrame>,
    events_tx: Sender<RealtimeEvent>,
) -> JoinHandle<()> {
    tokio::spawn(async move {
        loop {
            tokio::select! {
                biased;
                // ä¼˜å…ˆå¤„ç†æ–‡æœ¬è¾“å…¥
                text = text_rx.recv() => {
                    match text {
                        Ok(text) => {
                            if let Err(err) = writer.send_conversation_item_create(text).await {
                                warn!("failed to send input text: {mapped_error}");
                                break;
                            }
                        }
                        Err(_) => break,  // å‘é€ç«¯å·²å…³é—­
                    }
                }

                // å¤„ç†æ¥è‡ªåç«¯çš„äº‹ä»¶
                event = events.next_event() => {
                    match event {
                        Ok(Some(event)) => {
                            let should_stop = matches!(&event, RealtimeEvent::Error(_));
                            if events_tx.send(event).await.is_err() {
                                break;  // æ¥æ”¶ç«¯å·²å…³é—­
                            }
                            if should_stop {
                                error!("realtime stream error event received");
                                break;
                            }
                        }
                        Ok(None) => {
                            // è¿æ¥å·²å…³é—­
                            let _ = events_tx.send(RealtimeEvent::Error(
                                "realtime websocket connection is closed".to_string()
                            )).await;
                            break;
                        }
                        Err(err) => {
                            // è§£æé”™è¯¯
                            break;
                        }
                    }
                }

                // å¤„ç†éŸ³é¢‘è¾“å…¥
                frame = audio_rx.recv() => {
                    match frame {
                        Ok(frame) => {
                            if let Err(err) = writer.send_audio_frame(frame).await {
                                error!("failed to send input audio: {mapped_error}");
                                break;
                            }
                        }
                        Err(_) => break,
                    }
                }
            }
        }
    })
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

- `tokio::select! { biased; }` ç¡®ä¿æ–‡æœ¬å¤„ç†ä¼˜å…ˆçº§æœ€é«˜
- ä¸‰å‘å¤ç”¨ï¼šå¹¶å‘å¤„ç†æ–‡æœ¬ã€éŸ³é¢‘ã€äº‹ä»¶
- ä»»æ„ä¸€è·¯å¤±è´¥å³å…³é—­æ•´ä¸ªæµ

### 2.3 WebSocket å®¢æˆ·ç«¯å®ç°

**file**: `codex-rs/codex-api/src/endpoint/realtime_websocket/methods.rs`

#### æ ¸å¿ƒç»„ä»¶

**WsStream** - æ¶ˆæ¯æ³µ

```rust
struct WsStream {
    tx_command: mpsc::Sender<WsCommand>,  // å‘½ä»¤å‘é€ç«¯
    pump_task: tokio::task::JoinHandle<()>, // åå°ä»»åŠ¡
}

enum WsCommand {
    Send { message: Message, tx_result: oneshot::Sender<Result<(), WsError>> },
    Close { tx_result: oneshot::Sender<Result<(), WsError>> },
}
```

- **åŒå‘é€šä¿¡**ï¼šåœ¨å•ä¸ª WebSocket è¿æ¥ä¸ŠåŒæ—¶æ”¯æŒå‘é€å’Œæ¥æ”¶
- **æ¶ˆæ¯æ³µæ¨¡å¼**ï¼šç‹¬ç«‹çš„åå°ä»»åŠ¡å¤„ç†æ‰€æœ‰ WebSocket I/O
- **éé˜»å¡è®¾è®¡**ï¼šå‘é€ç«¯ä¸ä¼šå› ç­‰å¾…äº‹ä»¶è€Œé˜»å¡

**RealtimeWebsocketWriter** - å†™ç«¯

```rust
pub struct RealtimeWebsocketWriter {
    stream: Arc<WsStream>,
    is_closed: Arc<AtomicBool>,
}

impl RealtimeWebsocketWriter {
    pub async fn send_audio_frame(&self, frame: RealtimeAudioFrame) -> Result<(), ApiError>
    pub async fn send_conversation_item_create(&self, text: String) -> Result<(), ApiError>
    pub async fn send_session_update(...) -> Result<(), ApiError>
}
```

**RealtimeWebsocketEvents** - è¯»ç«¯

```rust
pub struct RealtimeWebsocketEvents {
    rx_message: Arc<Mutex<mpsc::UnboundedReceiver<Result<Message, WsError>>>>,
    is_closed: Arc<AtomicBool>,
}

pub async fn next_event(&self) -> Result<Option<RealtimeEvent>, ApiError>
```

- å¾ªç¯è¯»å– WebSocket æ¶ˆæ¯
- è·³è¿‡ Ping/Pong
- è§£ææ–‡æœ¬æ¶ˆæ¯ä¸º `RealtimeEvent`

#### å‡ºç«™æ¶ˆæ¯æ ¼å¼

**file**: `codex-rs/codex-api/src/endpoint/realtime_websocket/protocol.rs`

```rust
#[derive(Debug, Clone, Serialize)]
#[serde(tag = "type")]
enum RealtimeOutboundMessage {
    #[serde(rename = "response.input_audio.delta")]
    InputAudioDelta {
        delta: String,              // Base64éŸ³é¢‘
        sample_rate: u32,
        num_channels: u16,
        samples_per_channel: Option<u32>,
    },

    #[serde(rename = "session.create")]
    SessionCreate { session: SessionCreateSession },

    #[serde(rename = "session.update")]
    SessionUpdate { session: Option<SessionUpdateSession> },

    #[serde(rename = "conversation.item.create")]
    ConversationItemCreate { item: ConversationItem },
}
```

#### å…¥ç«™äº‹ä»¶è§£æ

```rust
pub(super) fn parse_realtime_event(payload: &str) -> Option<RealtimeEvent> {
    let parsed: Value = serde_json::from_str(payload)?;
    let message_type = parsed.get("type").and_then(Value::as_str)?;

    match message_type {
        "session.created" => {
            let session_id = parsed.get("session")
                .and_then(|s| s.get("id"))
                .and_then(Value::as_str)?;
            Some(RealtimeEvent::SessionCreated { session_id: session_id.to_string() })
        }
        "response.output_audio.delta" => {
            let data = parsed.get("delta").and_then(Value::as_str)?;
            let sample_rate = parsed.get("sample_rate").and_then(Value::as_u64)?;
            let num_channels = parsed.get("num_channels").and_then(Value::as_u64)?;
            Some(RealtimeEvent::AudioOut(RealtimeAudioFrame {
                data: data.to_string(),
                sample_rate: sample_rate as u32,
                num_channels: num_channels as u16,
                samples_per_channel: ...,
            }))
        }
        "conversation.item.added" => {
            let item = parsed.get("item").cloned()?;
            Some(RealtimeEvent::ConversationItemAdded(item))
        }
        "error" => {
            let message = parsed.get("message")
                .and_then(Value::as_str)?
                .to_string();
            Some(RealtimeEvent::Error(message))
        }
        _ => None,
    }
}
```

---

## 2.5 PCM éŸ³é¢‘å¸§ç¼“å†²è¯¦ç»†å®ç°

### 2.5.1 PCM æ ¼å¼è¯´æ˜

**PCM (Pulse Code Modulation)** æ˜¯ä¸€ç§æœªç»å‹ç¼©çš„åŸå§‹éŸ³é¢‘æ ¼å¼ï¼ŒRealtime API ä½¿ç”¨ PCM è¿›è¡ŒéŸ³é¢‘ä¼ è¾“ï¼š

```
PCM éŸ³é¢‘æ•°æ®ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PCM éŸ³é¢‘å¸§                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  é‡‡æ ·ç‡ (sample_rate)                                       â”‚
â”‚  â”œâ”€â”€ 8000 Hz   - ç”µè¯è´¨é‡                                   â”‚
â”‚  â”œâ”€â”€ 16000 Hz  - å®½å¸¦è¯­éŸ³                                   â”‚
â”‚  â”œâ”€â”€ 24000 Hz  - é«˜è´¨é‡è¯­éŸ³ï¼ˆOpenAI é»˜è®¤ï¼‰                  â”‚
â”‚  â”œâ”€â”€ 44100 Hz  - CD è´¨é‡                                    â”‚
â”‚  â””â”€â”€ 48000 Hz  - ä¸“ä¸šéŸ³é¢‘ï¼ˆCodex æµ‹è¯•ä¸­ä½¿ç”¨ï¼‰               â”‚
â”‚                                                             â”‚
â”‚  é€šé“æ•° (num_channels)                                      â”‚
â”‚  â”œâ”€â”€ 1 = å•å£°é“ï¼ˆè¯­éŸ³é€šä¿¡å¸¸ç”¨ï¼‰                             â”‚
â”‚  â””â”€â”€ 2 = ç«‹ä½“å£°                                             â”‚
â”‚                                                             â”‚
â”‚  æ ·æœ¬æ ¼å¼                                                   â”‚
â”‚  â”œâ”€â”€ 16-bit signed integerï¼ˆæœ€å¸¸ç”¨ï¼‰                        â”‚
â”‚  â””â”€â”€ Little-endian                                         â”‚
â”‚                                                             â”‚
â”‚  æ¯é€šé“æ ·æœ¬æ•° (samples_per_channel)                         â”‚
â”‚  â”œâ”€â”€ ä¾‹å¦‚ï¼š20ms @ 48kHz = 960 samples                       â”‚
â”‚  â””â”€â”€ ç”¨äºè®¡ç®—å¸§æ—¶é•¿å’Œç¼“å†²å¤§å°                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5.2 RealtimeAudioFrame æ•°æ®ç»“æ„

**file**: `codex-rs/protocol/src/protocol.rs`

```rust
#[derive(Debug, Clone, PartialEq, Eq, JsonSchema, TS)]
pub struct RealtimeAudioFrame {
    /// Base64 ç¼–ç çš„ PCM éŸ³é¢‘æ•°æ®
    /// åŸå§‹æ ¼å¼ï¼š16-bit signed integer, little-endian
    pub data: String,

    /// é‡‡æ ·ç‡ï¼ˆæ¯ç§’é‡‡æ ·æ¬¡æ•°ï¼‰
    /// å¸¸è§å€¼ï¼š8000, 16000, 24000, 44100, 48000
    pub sample_rate: u32,

    /// éŸ³é¢‘é€šé“æ•°
    /// 1 = å•å£°é“ï¼Œ2 = ç«‹ä½“å£°
    pub num_channels: u16,

    /// æ¯ä¸ªé€šé“çš„æ ·æœ¬æ•°ï¼ˆå¯é€‰ï¼‰
    /// ç”¨äºè®¡ç®—å¸§æ—¶é•¿ï¼šsamples_per_channel / sample_rate = ç§’æ•°
    #[serde(skip_serializing_if = "Option::is_none")]
    pub samples_per_channel: Option<u32>,
}
```

### 2.5.3 éŸ³é¢‘å¸§ä¼ è¾“æµç¨‹

```
éŸ³é¢‘æ•°æ®ä¼ è¾“å®Œæ•´æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. éŸ³é¢‘é‡‡é›†                                                 â”‚ â”‚
â”‚  â”‚    - éº¦å…‹é£ â†’ ADC â†’ PCM åŸå§‹æ•°æ®                           â”‚ â”‚
â”‚  â”‚    - ä¾‹å¦‚ï¼š48kHz, 16-bit, mono                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 2. åˆ†å¸§å¤„ç†                                                 â”‚ â”‚
â”‚  â”‚    - å°†è¿ç»­éŸ³é¢‘æµåˆ‡åˆ†ä¸ºå›ºå®šæ—¶é•¿å¸§                          â”‚ â”‚
â”‚  â”‚    - å…¸å‹å¸§é•¿ï¼š20ms (960 samples @ 48kHz)                  â”‚ â”‚
â”‚  â”‚    - æ¯å¸§æ•°æ®é‡ï¼š960 Ã— 2 bytes = 1920 bytes               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 3. Base64 ç¼–ç                                               â”‚ â”‚
â”‚  â”‚    - å°†äºŒè¿›åˆ¶ PCM è½¬æ¢ä¸º Base64 å­—ç¬¦ä¸²                     â”‚ â”‚
â”‚  â”‚    - ç¼–ç åå¤§å°å¢åŠ çº¦ 33%                                  â”‚ â”‚
â”‚  â”‚    - 1920 bytes â†’ ~2560 characters                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 4. æ„å»º RealtimeAudioFrame                                  â”‚ â”‚
â”‚  â”‚    {                                                        â”‚ â”‚
â”‚  â”‚      "data": "AAAA...ï¼ˆBase64ç¼–ç çš„PCMï¼‰",                  â”‚ â”‚
â”‚  â”‚      "sample_rate": 48000,                                  â”‚ â”‚
â”‚  â”‚      "num_channels": 1,                                     â”‚ â”‚
â”‚  â”‚      "samples_per_channel": 960                             â”‚ â”‚
â”‚  â”‚    }                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Op::RealtimeConversationAudio
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Codex Core                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 5. éŸ³é¢‘é˜Ÿåˆ—ç¼“å†² (audio_tx â†’ audio_rx)                       â”‚ â”‚
â”‚  â”‚    - æœ‰ç•Œé€šé“ï¼š256 å¸§å®¹é‡                                   â”‚ â”‚
â”‚  â”‚    - try_sendï¼šéé˜»å¡ï¼Œé˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒ                        â”‚ â”‚
â”‚  â”‚    - ç¼“å†²æ—¶é•¿ï¼š256 Ã— 20ms = 5.12 ç§’                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 6. åå°è¾“å…¥ä»»åŠ¡ (spawn_realtime_input_task)                â”‚ â”‚
â”‚  â”‚    - tokio::select! å¤šè·¯å¤ç”¨                               â”‚ â”‚
â”‚  â”‚    - ä» audio_rx æ¥æ”¶å¸§                                    â”‚ â”‚
â”‚  â”‚    - è°ƒç”¨ writer.send_audio_frame()                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ WebSocket JSON Message
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯ Realtime API                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 7. æ¥æ”¶å¹¶å¤„ç†                                               â”‚ â”‚
â”‚  â”‚    - è§£æ JSON                                             â”‚ â”‚
â”‚  â”‚    - Base64 è§£ç                                            â”‚ â”‚
â”‚  â”‚    - è¯­éŸ³è¯†åˆ« / å¤„ç†                                       â”‚ â”‚
â”‚  â”‚    - ç”Ÿæˆå“åº”                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5.4 é˜Ÿåˆ—ç¼“å†²å®ç°ç»†èŠ‚

**file**: `codex-rs/core/src/realtime_conversation.rs`

```rust
// é˜Ÿåˆ—å®¹é‡é…ç½®
const AUDIO_IN_QUEUE_CAPACITY: usize = 256;      // éŸ³é¢‘è¾“å…¥é˜Ÿåˆ—
const TEXT_IN_QUEUE_CAPACITY: usize = 64;        // æ–‡æœ¬è¾“å…¥é˜Ÿåˆ—
const OUTPUT_EVENTS_QUEUE_CAPACITY: usize = 256; // è¾“å‡ºäº‹ä»¶é˜Ÿåˆ—

// åˆå§‹åŒ–éŸ³é¢‘é€šé“
let (audio_tx, audio_rx) =
    async_channel::bounded::<RealtimeAudioFrame>(AUDIO_IN_QUEUE_CAPACITY);
```

**ç¼“å†²è®¡ç®—**ï¼š

| å‚æ•° | å€¼ | è®¡ç®—è¯´æ˜ |
|------|-----|---------|
| é˜Ÿåˆ—å®¹é‡ | 256 å¸§ | å¯é…ç½®å¸¸é‡ |
| å…¸å‹å¸§é•¿ | 20ms | 960 samples @ 48kHz |
| æ¯å¸§å¤§å° | ~2KB | 960 samples Ã— 2 bytes Ã— 1 channel |
| æ€»ç¼“å†²æ—¶é•¿ | ~5.1ç§’ | 256 Ã— 20ms |
| æ€»ç¼“å†²å†…å­˜ | ~512KB | 256 Ã— 2KB |

### 2.5.5 èƒŒå‹å¤„ç†æœºåˆ¶

```rust
pub(crate) async fn audio_in(&self, frame: RealtimeAudioFrame) -> CodexResult<()> {
    let sender = {
        let guard = self.state.lock().await;
        guard.as_ref().map(|state| state.audio_tx.clone())
    };

    let Some(sender) = sender else {
        return Err(CodexErr::InvalidRequest(
            "conversation is not running".to_string(),
        ));
    };

    match sender.try_send(frame) {
        Ok(()) => Ok(()),

        // å…³é”®ï¼šé˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒå¸§ï¼Œä¸é˜»å¡è°ƒç”¨è€…
        Err(TrySendError::Full(_)) => {
            warn!("dropping input audio frame due to full queue");
            Ok(())  // è¿”å› OKï¼Œé¿å…ä¸Šå±‚é‡è¯•
        }

        Err(TrySendError::Closed(_)) => Err(CodexErr::InvalidRequest(
            "conversation is not running".to_string(),
        )),
    }
}
```

**èƒŒå‹ç­–ç•¥é€‰æ‹©åŸå› **ï¼š

```
ä¸ºä»€ä¹ˆéŸ³é¢‘ä½¿ç”¨ä¸¢å¼ƒç­–ç•¥è€Œéé˜»å¡ï¼Ÿ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯ï¼šç”¨æˆ·æ­£åœ¨è¯´è¯ï¼ŒéŸ³é¢‘å¸§æŒç»­äº§ç”Ÿ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ é˜»å¡ç­–ç•¥çš„é—®é¢˜ï¼š                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 1. éŸ³é¢‘é‡‡é›†çº¿ç¨‹è¢«é˜»å¡                                â”‚   â”‚
â”‚ â”‚ 2. éº¦å…‹é£ç¼“å†²åŒºæº¢å‡º                                  â”‚   â”‚
â”‚ â”‚ 3. å®æ—¶æ€§ä¸§å¤±ï¼Œå»¶è¿Ÿç´¯ç§¯                              â”‚   â”‚
â”‚ â”‚ 4. ç”¨æˆ·ä½“éªŒä¸¥é‡ä¸‹é™                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ ä¸¢å¼ƒç­–ç•¥çš„ä¼˜åŠ¿ï¼š                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 1. é‡‡é›†çº¿ç¨‹æ°¸ä¸é˜»å¡                                  â”‚   â”‚
â”‚ â”‚ 2. ä¿æŒå®æ—¶æ€§ï¼Œå»¶è¿Ÿå¯æ§                              â”‚   â”‚
â”‚ â”‚ 3. è¯­éŸ³è¯†åˆ«å¯å®¹å¿å°‘é‡ä¸¢å¸§                            â”‚   â”‚
â”‚ â”‚ 4. ç³»ç»Ÿå“åº”æ€§ä¿æŒ                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ è¯­éŸ³è¯†åˆ«ç‰¹æ€§ï¼š                                              â”‚
â”‚ â€¢ è¿ç»­è¯­éŸ³æµä¸­ï¼Œä¸ªåˆ«å¸§ä¸¢å¤±ä¸å½±å“è¯†åˆ«å‡†ç¡®ç‡                  â”‚
â”‚ â€¢ ç›¸é‚»å¸§æœ‰é«˜åº¦ç›¸å…³æ€§ï¼Œä¿¡æ¯å†—ä½™åº¦é«˜                          â”‚
â”‚ â€¢ äººç±»è¯­éŸ³æœ‰è‡ªç„¶åœé¡¿ï¼Œä¸¢å¸§å¯è¢«ä¸Šä¸‹æ–‡è¡¥å¿                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5.6 WebSocket æ¶ˆæ¯æ ¼å¼

**å‡ºç«™æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯ â†’ åç«¯ï¼‰**ï¼š

```json
{
  "type": "response.input_audio.delta",
  "delta": "//uQxAAAAANIAAAAAEX...",   // Base64 ç¼–ç çš„ PCM
  "sample_rate": 48000,
  "num_channels": 1,
  "samples_per_channel": 960
}
```

**å…¥ç«™æ¶ˆæ¯ï¼ˆåç«¯ â†’ å®¢æˆ·ç«¯ï¼‰**ï¼š

```json
{
  "type": "response.output_audio.delta",
  "delta": "//uQxAAAAANIAAAAAEX...",   // Base64 ç¼–ç çš„ PCM
  "sample_rate": 24000,
  "num_channels": 1,
  "samples_per_channel": 480
}
```

### 2.5.7 éŸ³é¢‘å¸§å¤„ç†æ—¶åºå›¾

```
æ—¶é—´è½´ (48kHz, 20ms/å¸§)

t=0ms     t=20ms    t=40ms    t=60ms    t=80ms    t=100ms
  â”‚          â”‚         â”‚         â”‚         â”‚         â”‚
  â–¼          â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”
â”‚F1  â”‚    â”‚F2  â”‚    â”‚F3  â”‚    â”‚F4  â”‚    â”‚F5  â”‚    â”‚F6  â”‚
â”‚é‡‡é›†â”‚    â”‚é‡‡é›†â”‚    â”‚é‡‡é›†â”‚    â”‚é‡‡é›†â”‚    â”‚é‡‡é›†â”‚    â”‚é‡‡é›†â”‚
â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”˜
  â”‚          â”‚         â”‚         â”‚         â”‚         â”‚
  â”‚ try_send â”‚ try_sendâ”‚ try_sendâ”‚ try_sendâ”‚ try_sendâ”‚ try_send
  â–¼          â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    éŸ³é¢‘é˜Ÿåˆ— (256 å®¹é‡)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬                         â”‚
â”‚  â”‚ F1 â”‚ F2 â”‚ F3 â”‚ F4 â”‚ F5 â”‚ F6 â”‚ ...                     â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´                         â”‚
â”‚                                                            â”‚
â”‚  é˜Ÿåˆ—æ»¡æ—¶ï¼šæ–°å¸§ä¸¢å¼ƒï¼Œè­¦å‘Šæ—¥å¿—                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚          â”‚         â”‚         â”‚         â”‚         â”‚
  â”‚ recv     â”‚ recv    â”‚ recv    â”‚ recv    â”‚ recv    â”‚ recv
  â–¼          â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åå°è¾“å…¥ä»»åŠ¡ (tokio::select!)                  â”‚
â”‚                                                            â”‚
â”‚  loop {                                                    â”‚
â”‚    tokio::select! {                                        â”‚
â”‚      biased;  // æ–‡æœ¬ä¼˜å…ˆ                                  â”‚
â”‚      text = text_rx.recv() => { ... }                     â”‚
â”‚      event = events.next_event() => { ... }               â”‚
â”‚      frame = audio_rx.recv() => {                         â”‚
â”‚        writer.send_audio_frame(frame).await;  // WebSocketâ”‚
â”‚      }                                                     â”‚
â”‚    }                                                       â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚          â”‚         â”‚         â”‚         â”‚         â”‚
  â”‚ WS Send  â”‚ WS Send â”‚ WS Send â”‚ WS Send â”‚ WS Send â”‚ WS Send
  â–¼          â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebSocket è¿æ¥                           â”‚
â”‚                                                            â”‚
â”‚  Message: { "type": "response.input_audio.delta", ... }   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚          â”‚         â”‚         â”‚         â”‚         â”‚
  â”‚ ~5-10ms  â”‚ ~5-10ms â”‚ ~5-10ms â”‚ ~5-10ms â”‚ ~5-10ms â”‚ ~5-10ms
  â–¼          â–¼         â–¼         â–¼         â–¼         â–¼
                    åç«¯ Realtime API å¤„ç†
```

### 2.5.8 æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

**file**: `codex-rs/codex-api/src/endpoint/realtime_websocket/methods.rs`

```rust
#[test]
fn parse_audio_delta_event() {
    let payload = json!({
        "type": "response.output_audio.delta",
        "delta": "AAA=",           // Base64: 0x00, 0x00, 0x00
        "sample_rate": 48000,
        "num_channels": 1,
        "samples_per_channel": 960
    })
    .to_string();

    assert_eq!(
        parse_realtime_event(payload.as_str()),
        Some(RealtimeEvent::AudioOut(RealtimeAudioFrame {
            data: "AAA=".to_string(),
            sample_rate: 48000,
            num_channels: 1,
            samples_per_channel: Some(960),
        }))
    );
}

// E2E æµ‹è¯•ï¼šå‘é€éŸ³é¢‘å¸§
connection
    .send_audio_frame(RealtimeAudioFrame {
        data: "AQID".to_string(),   // Base64: 0x01, 0x02, 0x03
        sample_rate: 48000,
        num_channels: 1,
        samples_per_channel: Some(960),
    })
    .await
    .expect("send audio");
```

---

## 3. æ“ä½œå¤„ç†æµç¨‹

### 3.1 Session çº§åˆ«çš„æ“ä½œåˆ†å‘

**file**: `codex-rs/core/src/codex.rs`

```rust
// åœ¨ submission_queue_processor å¾ªç¯ä¸­
match sub.op.clone() {
    Op::RealtimeConversationStart(params) => {
        handle_realtime_conversation_start(&sess, sub.id.clone(), params).await
    }
    Op::RealtimeConversationAudio(params) => {
        handle_realtime_conversation_audio(&sess, sub.id.clone(), params).await
    }
    Op::RealtimeConversationText(params) => {
        handle_realtime_conversation_text(&sess, sub.id.clone(), params).await
    }
    Op::RealtimeConversationClose => {
        handle_realtime_conversation_close(&sess, sub.id.clone()).await
    }
    // ...
}
```

### 3.2 å¯åŠ¨æµç¨‹è¯¦è§£

```rust
pub(crate) async fn handle_start(
    sess: &Arc<Session>,
    sub_id: String,
    params: ConversationStartParams,
) -> CodexResult<()> {
    // 1. è·å–æä¾›è€…å’Œè®¤è¯
    let provider = sess.provider().await;
    let auth = sess.services.auth_manager.auth().await;
    let mut api_provider = provider.to_api_provider(
        auth.as_ref().map(CodexAuth::auth_mode)
    )?;

    // 2. åº”ç”¨é…ç½®è¦†ç›–
    let config = sess.get_config().await;
    if let Some(realtime_ws_base_url) = &config.experimental_realtime_ws_base_url {
        api_provider.base_url = realtime_ws_base_url.clone();
    }

    // 3. ç¡®å®š promptï¼ˆé…ç½®ä¼˜å…ˆçº§é«˜äºå‚æ•°ï¼‰
    let prompt = config
        .experimental_realtime_ws_backend_prompt
        .clone()
        .unwrap_or(params.prompt);

    // 4. å¯åŠ¨å¯¹è¯ç®¡ç†å™¨
    let events_rx = match sess.conversation.start(
        api_provider,
        None,
        prompt,
        requested_session_id.clone(),
    ).await {
        Ok(events_rx) => events_rx,
        Err(err) => {
            send_conversation_error(sess, sub_id, err.to_string(), CodexErrorInfo::Other).await;
            return Ok(());
        }
    };

    // 5. å‘é€å¯åŠ¨äº‹ä»¶
    sess.send_event_raw(Event {
        id: sub_id.clone(),
        msg: EventMsg::RealtimeConversationStarted(RealtimeConversationStartedEvent {
            session_id: requested_session_id,
        }),
    }).await;

    // 6. å¯åŠ¨äº‹ä»¶è½¬å‘ä»»åŠ¡
    let sess_clone = Arc::clone(sess);
    tokio::spawn(async move {
        while let Ok(event) = events_rx.recv().await {
            sess_clone.send_event_raw(Event {
                id: sub_id.clone(),
                msg: EventMsg::RealtimeConversationRealtime(
                    RealtimeConversationRealtimeEvent { payload: event }
                ),
            }).await;
        }

        // å¯¹è¯æµç»ˆæ­¢æ—¶å‘é€å…³é—­äº‹ä»¶
        if let Some(()) = sess_clone.conversation.running_state().await {
            sess_clone.send_event_raw(Event {
                id: sub_id.clone(),
                msg: EventMsg::RealtimeConversationClosed(
                    RealtimeConversationClosedEvent {
                        reason: Some("transport_closed".to_string()),
                    }
                ),
            }).await;
        }
    });

    Ok(())
}
```

**å…³é”®ç‚¹**ï¼š

- é…ç½®å¯è¦†ç›– API åŸºç¡€ URLï¼ˆæ”¯æŒæµ‹è¯•ï¼‰
- åç«¯ prompt å¯é…ç½®çº§è”
- å¯¹è¯ç®¡ç†å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºä¼šè¯
- ä½¿ç”¨ç‹¬ç«‹ä»»åŠ¡å¤„ç†äº‹ä»¶è½¬å‘ï¼Œä¸é˜»å¡æäº¤å¤„ç†é˜Ÿåˆ—

### 3.3 æ•°æ®è¾“å…¥æµç¨‹

**éŸ³é¢‘è¾“å…¥**

```rust
pub(crate) async fn handle_audio(
    sess: &Arc<Session>,
    sub_id: String,
    params: ConversationAudioParams,
) {
    if let Err(err) = sess.conversation.audio_in(params.frame).await {
        send_conversation_error(
            sess,
            sub_id,
            err.to_string(),
            CodexErrorInfo::BadRequest,
        ).await;
    }
}
```

**æ–‡æœ¬è¾“å…¥**

```rust
pub(crate) async fn handle_text(
    sess: &Arc<Session>,
    sub_id: String,
    params: ConversationTextParams,
) {
    if let Err(err) = sess.conversation.text_in(params.text).await {
        send_conversation_error(
            sess,
            sub_id,
            err.to_string(),
            CodexErrorInfo::BadRequest,
        ).await;
    }
}
```

**å…³é—­æµç¨‹**

```rust
pub(crate) async fn handle_close(
    sess: &Arc<Session>,
    sub_id: String,
) {
    match sess.conversation.shutdown().await {
        Ok(()) => {
            sess.send_event_raw(Event {
                id: sub_id,
                msg: EventMsg::RealtimeConversationClosed(
                    RealtimeConversationClosedEvent {
                        reason: Some("requested".to_string()),
                    }
                ),
            }).await;
        }
        Err(err) => {
            send_conversation_error(
                sess,
                sub_id,
                err.to_string(),
                CodexErrorInfo::Other,
            ).await;
        }
    }
}
```

---

## 4. æ•°æ®æµå›¾

### 4.1 å®Œæ•´çš„æ¶ˆæ¯æµ

```
å®¢æˆ·ç«¯                           Codex                    åç«¯ Realtime API
  â”‚                              â”‚                              â”‚
  â”œâ”€ Submit(RealtimeConversationStart) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
  â”‚                              â”‚                              â”‚
  â”‚                              â”‚         WebSocket Connect    â”‚
  â”‚                              â”œâ”€ Session.create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                              â”‚                              â”‚
  â”‚  â† Event(RealtimeStarted)    â”‚         Session.created     â”‚
  â”‚  â† Event(Realtime)           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚    {SessionCreated}          â”‚                              â”‚
  â”‚                              â”‚                              â”‚
  â”œâ”€ Submit(RealtimeConversationAudio) â”€â”€â”€â”€â”€â”€â”                 â”‚
  â”‚                              â”‚           â”‚  (try_send)      â”‚
  â”‚                              â”‚           â–¼                 â”‚
  â”‚                              â”‚    [Audio Queue]            â”‚
  â”‚                              â”‚           â”‚                 â”‚
  â”‚                              â”‚           â”‚ [Input Task]    â”‚
  â”‚                              â”œâ”€ InputAudioDelta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                              â”‚                              â”‚
  â”‚                              â”‚    OutputAudioDelta         â”‚
  â”‚  â† Event(Realtime)           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚    {AudioOut}                â”‚                              â”‚
  â”‚                              â”‚                              â”‚
  â”œâ”€ Submit(RealtimeConversationText) â”€â”€â”€â”                     â”‚
  â”‚                              â”‚       â”‚ (send)              â”‚
  â”‚                              â”‚       â–¼                     â”‚
  â”‚                              â”‚    [Text Queue]             â”‚
  â”‚                              â”‚       â”‚                     â”‚
  â”‚                              â”œâ”€ ConversationItemCreate â”€â”€â”€â†’â”‚
  â”‚                              â”‚                              â”‚
  â”‚                              â”‚    ConversationItemAdded    â”‚
  â”‚  â† Event(Realtime)           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚    {ConversationItemAdded}   â”‚                              â”‚
  â”‚                              â”‚                              â”‚
  â”œâ”€ Submit(RealtimeConversationClose) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
  â”‚                              â”‚                              â”‚
  â”‚  â† Event(RealtimeClosed)     â”‚         WebSocket Close     â”‚
  â”‚    {reason: "requested"}     â”‚        or transport_closed   â”‚
```

### 4.2 é€šé“é€šä¿¡æ‹“æ‰‘

```
RealtimeConversationManager å†…éƒ¨ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RealtimeConversationManager                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Mutex<Option<ConversationState>>     â”‚   â”‚
    â”‚  â”‚  - audio_tx: Sender                  â”‚   â”‚
    â”‚  â”‚  - text_tx: Sender                   â”‚   â”‚
    â”‚  â”‚  - task: JoinHandle                  â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚                     â”‚
    â–¼                 â–¼                     â–¼
audio_rx:       text_rx:                task:
Channel         Channel                 spawn_realtime_input_task()
256 cap.        64 cap.                 â”‚
    â”‚                 â”‚                  â”‚
    â”‚                 â”‚            â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚            â”‚            â”‚
    â”‚                 â”‚            â–¼            â–¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  â”‚          â”‚
           tokio::select! {  â”‚
              biased;        â”‚
              text_rx        â”‚ events.next_event()
              audio_rx       â”‚ writer.send_*()
           }    â”‚            â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
              events_tx: Sender<RealtimeEvent>
              256 capacity
                     â”‚
                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ handle_start() - Event Relay   â”‚
    â”‚ tokio::spawn() async loop      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            sess.send_event_raw()
            (to client)
```

---

## 5. é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

### 5.1 é˜Ÿåˆ—èƒŒå‹å¤„ç†

```rust
pub(crate) async fn audio_in(&self, frame: RealtimeAudioFrame) -> CodexResult<()> {
    let sender = {
        let guard = self.state.lock().await;
        guard.as_ref().map(|state| state.audio_tx.clone())
    };

    let Some(sender) = sender else {
        return Err(CodexErr::InvalidRequest("conversation is not running".to_string()));
    };

    match sender.try_send(frame) {
        Ok(()) => Ok(()),

        // é˜Ÿåˆ—æ»¡æ—¶ä¼˜é›…ä¸¢å¼ƒï¼Œä¸é˜»å¡æäº¤å¤„ç†
        Err(TrySendError::Full(_)) => {
            warn!("dropping input audio frame due to full queue");
            Ok(())
        }

        // æ¥æ”¶ç«¯å…³é—­
        Err(TrySendError::Closed(_)) => Err(CodexErr::InvalidRequest(
            "conversation is not running".to_string(),
        )),
    }
}
```

**è®¾è®¡åŸåˆ™**ï¼š

- éŸ³é¢‘ä½¿ç”¨ `try_send` ä»¥é¿å…é˜»å¡
- é˜Ÿåˆ—æ»¡æ—¶è®°å½•è­¦å‘Šå¹¶ä¸¢å¼ƒï¼Œä¿æŒç³»ç»Ÿå“åº”æ€§
- æ–‡æœ¬ä½¿ç”¨ `send` ç¡®ä¿ä¸ä¸¢å¤±

### 5.2 è¿æ¥å¤±è´¥å¤„ç†

```rust
// å¯åŠ¨æ—¶è¿æ¥å¤±è´¥
let events_rx = match sess.conversation.start(...).await {
    Ok(events_rx) => events_rx,
    Err(err) => {
        // å‘é€é”™è¯¯äº‹ä»¶ç»™å®¢æˆ·ç«¯
        send_conversation_error(
            sess,
            sub_id,
            err.to_string(),
            CodexErrorInfo::Other,
        ).await;
        return Ok(());
    }
};
```

### 5.3 æ“ä½œå‰æ£€æŸ¥

```rust
// å‘é€å‰æ£€æŸ¥å¯¹è¯æ˜¯å¦è¿è¡Œ
if let Some(state) = running_state {
    // å¯¹è¯æ­£åœ¨è¿è¡Œ
} else {
    return Err(CodexErr::InvalidRequest("conversation is not running".to_string()));
}
```

### 5.4 è¾“å…¥ä»»åŠ¡çš„åœæ­¢æ¡ä»¶

```rust
tokio::select! {
    // ä»»ä½•åˆ†æ”¯å‡ºé”™éƒ½ä¼šå¯¼è‡´å¾ªç¯é€€å‡º
    event = events.next_event() => {
        match event {
            Ok(Some(event)) => {
                let should_stop = matches!(&event, RealtimeEvent::Error(_));
                // ...
                if should_stop {
                    error!("realtime stream error event received");
                    break;  // â† é”™è¯¯äº‹ä»¶å¯¼è‡´é€€å‡º
                }
            }
            Ok(None) => break,      // â† è¿æ¥å·²å…³é—­
            Err(err) => break,      // â† è§£æé”™è¯¯
        }
    }
    frame = audio_rx.recv() => {
        Err(_) => break,            // â† å‘é€ç«¯å·²å…³é—­
    }
    text = text_rx.recv() => {
        Err(_) => break,            // â† å‘é€ç«¯å·²å…³é—­
    }
}
```

---

## 6. å…³é”®è®¾è®¡å†³ç­–

### 6.1 ä¸ºä»€ä¹ˆä½¿ç”¨ Mutex<Option<ConversationState>>ï¼Ÿ

```rust
pub(crate) struct RealtimeConversationManager {
    state: Mutex<Option<ConversationState>>,
}
```

**ä¼˜åŠ¿**ï¼š

- **åŸå­æ€§**ï¼šæ£€æŸ¥å’Œæ›¿æ¢åœ¨ä¸€ä¸ªåŸå­æ“ä½œä¸­
- **æ—§å¯¹è¯æ¸…ç†**ï¼šå¯åŠ¨æ–°å¯¹è¯æ—¶è‡ªåŠ¨ä¸­æ­¢æ—§ä»»åŠ¡
- **çŠ¶æ€æ˜ç¡®**ï¼š`Some` = å¯¹è¯è¿è¡Œï¼Œ`None` = ç©ºé—²

**å®ç°**ï¼š

```rust
let previous_state = {
    let mut guard = self.state.lock().await;
    guard.take()  // åŸå­æ€§æ›¿æ¢
};
if let Some(state) = previous_state {
    state.task.abort();  // æ¸…ç†æ—§ä»»åŠ¡
    let _ = state.task.await;
}
```

### 6.2 ä¸ºä»€ä¹ˆåˆ†ç¦»å†™ç«¯å’Œè¯»ç«¯ï¼Ÿ

```rust
pub struct RealtimeWebsocketWriter { ... }
pub struct RealtimeWebsocketEvents { ... }
```

**åŸå› **ï¼š

- **å¯å…‹éš†æ€§**ï¼š`Writer` å¯è¢«å¤šä¸ªè¾“å…¥æºå¹¶å‘ä½¿ç”¨
- **æ‰€æœ‰æƒæ˜ç¡®**ï¼šè¯»ç«¯å’Œå†™ç«¯çš„èŒè´£ç•Œé™æ¸…æ™°
- **ç±»å‹å®‰å…¨**ï¼šé˜²æ­¢è¯¯ç”¨ï¼ˆå¦‚åœ¨è¯»ç«¯å‘é€æ¶ˆæ¯ï¼‰

### 6.3 ä¸ºä»€ä¹ˆä½¿ç”¨ tokio::select! biasedï¼Ÿ

```rust
tokio::select! {
    biased;
    text = text_rx.recv() => { ... }
    event = events.next_event() => { ... }
    frame = audio_rx.recv() => { ... }
}
```

**åŸå› **ï¼š

- **ä¼˜å…ˆçº§æ§åˆ¶**ï¼šç¡®ä¿ç”¨æˆ·æ–‡æœ¬è¾“å…¥ä¼˜å…ˆå¤„ç†
- **å¯é¢„æµ‹æ€§**ï¼šé¿å…éŸ³é¢‘è¿‡è½½å¯¼è‡´æ–‡æœ¬å»¶è¿Ÿ
- **å…¬å¹³æ€§**ï¼š`biased` ä¿è¯ç¬¬ä¸€ä¸ªåˆ†æ”¯æœ€é«˜ä¼˜å…ˆçº§

### 6.4 ä¸ºä»€ä¹ˆå¯¹éŸ³é¢‘å’Œæ–‡æœ¬ä½¿ç”¨ä¸åŒçš„å‘é€ç­–ç•¥ï¼Ÿ

```rust
// éŸ³é¢‘ï¼štry_sendï¼ˆéé˜»å¡ï¼‰
match sender.try_send(frame) {
    Ok(()) => Ok(()),
    Err(TrySendError::Full(_)) => {
        warn!("dropping input audio frame due to full queue");
        Ok(())  // ä¸¢å¼ƒä½†è¿”å›OK
    }
}

// æ–‡æœ¬ï¼šsendï¼ˆå¼‚æ­¥é˜»å¡ï¼‰
sender.send(text).await
    .map_err(|_| CodexErr::InvalidRequest(...))?;
```

**åŸå› **ï¼š

- **éŸ³é¢‘æµç‰¹æ€§**ï¼šå®æ—¶æµä¸åº”é˜»å¡æäº¤å¤„ç†ï¼›æ—§å¸§ä¸¢å¼ƒæ— å®³
- **æ–‡æœ¬ç‰¹æ€§**ï¼šç”¨æˆ·è¾“å…¥åº”ç¡®ä¿åˆ°è¾¾ï¼›å¯æ¥å—ç­‰å¾…

---

## 7. æµ‹è¯•è¦†ç›–

**file**: `codex-rs/core/tests/suite/realtime_conversation.rs`

### 7.1 æ ¸å¿ƒæµ‹è¯•åœºæ™¯

1. **å®Œæ•´å¾€è¿”æµ‹è¯•** (`conversation_start_audio_text_close_round_trip`)
   - å¯åŠ¨ â†’ å‘é€éŸ³é¢‘ â†’ å‘é€æ–‡æœ¬ â†’ æ¥æ”¶äº‹ä»¶ â†’ å…³é—­

2. **ä¼ è¾“å…³é—­æ£€æµ‹** (`conversation_transport_close_emits_closed_event`)
   - éªŒè¯åç«¯ä¸»åŠ¨å…³é—­æ—¶çš„äº‹ä»¶é€šçŸ¥

3. **çŠ¶æ€æ£€æŸ¥** (`conversation_audio_before_start_emits_error`)
   - å¯åŠ¨å‰å‘é€éŸ³é¢‘åº”è¿”å›é”™è¯¯

4. **å¤šä¼šè¯æ›¿æ¢** (`conversation_second_start_replaces_runtime`)
   - ç¬¬äºŒæ¬¡å¯åŠ¨è‡ªåŠ¨ä¸­æ­¢ç¬¬ä¸€æ¬¡

5. **é…ç½®è¦†ç›–**
   - åŸºç¡€ URL è¦†ç›–æµ‹è¯•
   - åç«¯ prompt è¦†ç›–æµ‹è¯•

### 7.2 æµ‹è¯•åŸºç¡€è®¾æ–½

```rust
// æ¨¡æ‹Ÿ WebSocket æœåŠ¡å™¨
let server = start_websocket_server(vec![
    vec![],  // åˆå§‹è¿æ¥æ— æ¶ˆæ¯
    vec![
        vec![json!({
            "type": "session.created",
            "session": { "id": "sess_1" }
        })],
        // ...
    ],
]).await;

// ç­‰å¾…æ¡æ‰‹
assert!(server.wait_for_handshakes(1, Duration::from_secs(2)).await);

// éªŒè¯è¿æ¥çš„æ¶ˆæ¯
let connections = server.connections();
assert_eq!(connections[0].body_json()["type"].as_str(), Some("session.create"));
```

---

## 8. ä¸å…¶ä»–æ¨¡å—çš„äº¤äº’

### 8.1 Session é›†æˆ

**ä½ç½®**ï¼šSession ç»“æ„ä½“

```rust
pub(crate) struct Session {
    pub(crate) conversation: Arc<RealtimeConversationManager>,
    // ...
}
```

**åˆå§‹åŒ–**ï¼š

```rust
let conversation = Arc::new(RealtimeConversationManager::new());
```

### 8.2 æä¾›è€…ç®¡ç†

```rust
// ä»ä¼šè¯è·å–æä¾›è€…
let provider = sess.provider().await;

// åº”ç”¨è®¤è¯
let auth = sess.services.auth_manager.auth().await;
let api_provider = provider.to_api_provider(
    auth.as_ref().map(CodexAuth::auth_mode)
)?;
```

### 8.3 é…ç½®ç³»ç»Ÿ

```rust
// å®éªŒæ€§ WebSocket åŸºç¡€ URL
config.experimental_realtime_ws_base_url: Option<String>

// å®éªŒæ€§åç«¯ prompt
config.experimental_realtime_ws_backend_prompt: Option<String>
```

---

## 9. æ€§èƒ½ç‰¹å¾

### 9.1 å†…å­˜ä½¿ç”¨

| ç»„ä»¶ | å®¹é‡ | ç”¨é€” |
|------|------|------|
| éŸ³é¢‘é˜Ÿåˆ— | 256 | PCM å¸§ç¼“å†² |
| æ–‡æœ¬é˜Ÿåˆ— | 64 | ç”¨æˆ·è¾“å…¥ç¼“å†² |
| äº‹ä»¶é˜Ÿåˆ— | 256 | åç«¯äº‹ä»¶ç¼“å†² |

**æ€»ä½“å†…å­˜å ç”¨**ï¼š

- æ¯ä¸ªæ´»è·ƒå¯¹è¯çº¦ ~100KB å›ºå®šå¼€é”€
- é˜Ÿåˆ—å†…å­˜å–å†³äºæ¶ˆæ¯å¤§å°

### 9.2 å»¶è¿Ÿç‰¹æ€§

- **éŸ³é¢‘åˆ°åç«¯**ï¼š~5-10msï¼ˆä¸åŒ…æ‹¬ç½‘ç»œå¾€è¿”æ—¶é—´ï¼‰
- **æ–‡æœ¬åˆ°åç«¯**ï¼š~5-10msï¼ˆå¼‚æ­¥å‘é€ï¼‰
- **äº‹ä»¶åˆ°å®¢æˆ·ç«¯**ï¼š~1-5msï¼ˆç¼“å†²è½¬å‘ï¼‰

### 9.3 ååé‡

- **éŸ³é¢‘**ï¼šæ”¯æŒ 44100+ é‡‡æ ·ç‡ Ã— 256 å¸§é˜Ÿåˆ—
- **æ–‡æœ¬**ï¼š64 æ¡æ¶ˆæ¯é˜Ÿåˆ—
- **äº‹ä»¶**ï¼š256 æ¡äº‹ä»¶ç¼“å†²

---

## 10. æœ€è¿‘æ›´æ–°å†å²

åŸºäºæœ€è¿‘ä¸¤å¤©çš„ git æäº¤ï¼š

| Commit | æè¿° |
|--------|------|
| b73c4b50a | ä¿®å¤ realtime conversation flaky test - ä½¿å…¶é¡ºåºæ— å…³ |
| 5e505ff87 | Revert "Route inbound realtime text into turn start or steer" |
| 031d70170 | Route inbound realtime text into turn start or steer |
| b17148f13 | ä¼˜å…ˆä½¿ç”¨ v2 WebSocketsï¼ˆå¦‚å¯ç”¨ï¼‰ |
| a6b2bacb5 | é˜²æ­¢é‡æ”¾çš„è¿è¡Œæ—¶äº‹ä»¶å¼ºåˆ¶æ´»åŠ¨çŠ¶æ€ |
| 6817f0be8 | å°† realtime API è¿æ¥åˆ° core |
| b237f7cbb | æ·»åŠ å®éªŒæ€§ realtime websocket åç«¯ prompt è¦†ç›– |
| 7ae5d8801 | æ·»åŠ å®éªŒæ€§ realtime websocket URL è¦†ç›– |

---

## 11. æ€»ç»“

Codex çš„ Realtime API å®ç°ä½“ç°äº†ä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

| åŸåˆ™ | å®ç°æ–¹å¼ |
|------|--------|
| **éš”ç¦»** | ä½¿ç”¨ç‹¬ç«‹çš„ `RealtimeConversationManager` å’Œåå°ä»»åŠ¡ |
| **å¹¶å‘æ€§** | å¼‚æ­¥é€šé“å’Œ `tokio::select!` æ”¯æŒä¸‰å‘å¤ç”¨ |
| **å®¹é”™æ€§** | é˜Ÿåˆ—èƒŒå‹å¤„ç†ã€è¿æ¥ç›‘æ§ã€è‡ªåŠ¨é‡å¯ |
| **å“åº”æ€§** | éé˜»å¡éŸ³é¢‘å¤„ç†ã€ä¼˜å…ˆçº§é˜Ÿåˆ—é€‰æ‹© |
| **å¯æµ‹è¯•æ€§** | æ¨¡æ‹Ÿ WebSocket æœåŠ¡å™¨ã€å®Œæ•´æµ‹è¯•å¥—ä»¶ |
| **é…ç½®çµæ´»æ€§** | æ”¯æŒåŸºç¡€ URL å’Œ prompt è¦†ç›– |

**æ¶æ„ä¼˜åŠ¿**ï¼š

- æ”¯æŒåŒæ­¥å¤šä¸ªå¯¹è¯è¿æ¥ï¼ˆSession çº§åˆ«éš”ç¦»ï¼‰
- éŸ³é¢‘ä¸ä¼šé˜»å¡æ–‡æœ¬å¤„ç†ï¼ˆèƒŒå‹å¤„ç†ï¼‰
- åç«¯å…³é—­è‡ªåŠ¨æ£€æµ‹ï¼ˆäº‹ä»¶ç›‘æ§ï¼‰
- å®Œæ•´çš„é”™è¯¯æŠ¥å‘Šï¼ˆåˆ†å±‚é”™è¯¯å¤„ç†ï¼‰
- æ˜“äºæµ‹è¯•å’Œæ‰©å±•ï¼ˆæ¨¡å—åŒ–è®¾è®¡ï¼‰

**å…³é”®æ–‡ä»¶**ï¼š

- `codex-rs/core/src/realtime_conversation.rs` - æ ¸å¿ƒç®¡ç†å™¨
- `codex-rs/core/src/codex.rs` - æ“ä½œåˆ†å‘
- `codex-rs/protocol/src/protocol.rs` - ç±»å‹å®šä¹‰
- `codex-rs/codex-api/src/endpoint/realtime_websocket/` - WebSocket å®¢æˆ·ç«¯
- `codex-rs/core/tests/suite/realtime_conversation.rs` - æµ‹è¯•å¥—ä»¶

---

## é™„å½• A: å¿«é€Ÿå‚è€ƒ

### A.1 æ ¸å¿ƒ API æ“ä½œ

| æ“ä½œ | ç”¨é€” | å‚æ•° |
|------|------|------|
| `RealtimeConversationStart` | å¯åŠ¨å®æ—¶å¯¹è¯ | `prompt`, `session_id` |
| `RealtimeConversationAudio` | å‘é€éŸ³é¢‘å¸§ | `RealtimeAudioFrame` |
| `RealtimeConversationText` | å‘é€æ–‡æœ¬ | `text` |
| `RealtimeConversationClose` | å…³é—­å¯¹è¯ | æ—  |

### A.2 éŸ³é¢‘å‚æ•°å‚è€ƒ

| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| `sample_rate` | 48000 | ä¸“ä¸šéŸ³é¢‘è´¨é‡ï¼Œä¹Ÿæ”¯æŒ 24000 |
| `num_channels` | 1 | å•å£°é“ï¼Œè¯­éŸ³é€šä¿¡æ ‡å‡† |
| `samples_per_channel` | 960 | 20ms @ 48kHz |
| å¸§æ—¶é•¿ | 20ms | å¹³è¡¡å»¶è¿Ÿå’Œæ•ˆç‡ |

### A.3 é˜Ÿåˆ—å®¹é‡å‚è€ƒ

| é˜Ÿåˆ— | å®¹é‡ | ç¼“å†²æ—¶é•¿ | å‘é€ç­–ç•¥ |
|------|------|----------|----------|
| éŸ³é¢‘è¾“å…¥ | 256 | ~5.1s | `try_send`ï¼ˆå¯ä¸¢å¼ƒï¼‰ |
| æ–‡æœ¬è¾“å…¥ | 64 | N/A | `send`ï¼ˆç¡®ä¿é€è¾¾ï¼‰ |
| äº‹ä»¶è¾“å‡º | 256 | N/A | `send`ï¼ˆç¡®ä¿é€è¾¾ï¼‰ |

---

## é™„å½• B: å…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|----------|------|
| `codex-rs/protocol/src/protocol.rs` | ç±»å‹å®šä¹‰ï¼ˆOp, RealtimeAudioFrame, RealtimeEventï¼‰ |
| `codex-rs/core/src/realtime_conversation.rs` | æ ¸å¿ƒç®¡ç†å™¨ã€é˜Ÿåˆ—ç¼“å†²ã€åå°ä»»åŠ¡ |
| `codex-rs/core/src/codex.rs` | æ“ä½œåˆ†å‘ã€Session é›†æˆ |
| `codex-rs/codex-api/src/endpoint/realtime_websocket/methods.rs` | WebSocket å®¢æˆ·ç«¯å®ç° |
| `codex-rs/codex-api/src/endpoint/realtime_websocket/protocol.rs` | åè®®ç¼–è§£ç  |
| `codex-rs/core/tests/suite/realtime_conversation.rs` | æµ‹è¯•å¥—ä»¶ |
| `codex-rs/app-server-protocol/schema/typescript/RealtimeAudioFrame.ts` | TypeScript ç±»å‹å®šä¹‰ |

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-02-22*
*åŸºäº git æäº¤å†å²å’Œæºä»£ç åˆ†æ*
*è¡¥å……ï¼šRealtime API ç”¨é€”è¯´æ˜ä¸ PCM éŸ³é¢‘å¸§å®ç°ç»†èŠ‚*
